@page
@model SkillsModel
@{
    ViewData["Title"] = "技能管理";
    ViewData["ActivePage"] = "Skills";
}

<div class="row mb-4">
    <div class="col-12">
        <h4 class="mb-0">技能管理</h4>
        <small class="text-muted">技能列表、给予技能、修改技能属性</small>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <i class="bi bi-magic"></i> 给予技能 <span class="badge bg-warning text-dark">需要 Admin 权限</span>
            </div>
            <div class="card-body">
                <form method="post" asp-page-handler="GiveSkill">
                    <div class="row g-2">
                        <div class="col-md-4">
                            <label class="form-label">玩家名称</label>
                            <input type="text" class="form-control" name="playerName" id="giveSkillPlayerName" placeholder="在线玩家角色名" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">技能 ID</label>
                            <input type="number" class="form-control" name="magicIndex" id="giveSkillMagicIndex" placeholder="技能索引" min="0" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">等级</label>
                            <input type="number" class="form-control" name="level" value="1" min="0" max="6">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-plus-circle"></i> 给予
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-danger text-white">
                <i class="bi bi-stars"></i> 全职业技能 <span class="badge bg-warning text-dark">需要 SuperAdmin 权限</span>
            </div>
            <div class="card-body">
                <form method="post" asp-page-handler="GiveAllSkills" onsubmit="return confirm('确定要给该玩家添加所有职业技能吗？')">
                    <div class="row g-2">
                        <div class="col-md-6">
                            <label class="form-label">玩家名称</label>
                            <input type="text" class="form-control" name="playerName" placeholder="在线玩家角色名" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">技能等级</label>
                            <input type="number" class="form-control" name="level" value="3" min="0" max="6">
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-danger w-100">
                                <i class="bi bi-lightning-fill"></i> 全技能
                            </button>
                        </div>
                    </div>
                    <small class="text-muted mt-2 d-block">给玩家添加其职业的所有技能</small>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Remove Skill -->
<div class="card mb-4">
    <div class="card-header bg-warning text-dark">
        <i class="bi bi-trash"></i> 移除技能 <span class="badge bg-danger">需要 Admin 权限</span>
    </div>
    <div class="card-body">
        <form method="post" asp-page-handler="RemoveSkill" onsubmit="return confirm('确定要移除该玩家的技能吗？')">
            <div class="row g-2">
                <div class="col-md-4">
                    <label class="form-label">玩家名称</label>
                    <input type="text" class="form-control" name="playerName" placeholder="在线玩家角色名" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">技能 ID</label>
                    <input type="number" class="form-control" name="magicIndex" id="removeSkillMagicIndex" placeholder="要移除的技能索引" min="0" required>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn btn-warning w-100">
                        <i class="bi bi-x-circle"></i> 移除技能
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Search & Filter -->
<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-search"></i> 搜索筛选
    </div>
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">关键字</label>
                <input type="text" class="form-control" name="Keyword" value="@Model.Keyword" placeholder="技能名称/ID">
            </div>
            <div class="col-md-3">
                <label class="form-label">职业</label>
                <select class="form-select" name="ClassFilter">
                    <option value="">全部职业</option>
                    <option value="Warrior" selected="@(Model.ClassFilter == "Warrior")">战士</option>
                    <option value="Wizard" selected="@(Model.ClassFilter == "Wizard")">法师</option>
                    <option value="Taoist" selected="@(Model.ClassFilter == "Taoist")">道士</option>
                    <option value="Assassin" selected="@(Model.ClassFilter == "Assassin")">刺客</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">类型</label>
                <select class="form-select" name="SchoolFilter">
                    <option value="">全部类型</option>
                    <option value="None" selected="@(Model.SchoolFilter == "None")">无</option>
                    <option value="Combat" selected="@(Model.SchoolFilter == "Combat")">战斗</option>
                    <option value="Elemental" selected="@(Model.SchoolFilter == "Elemental")">元素</option>
                    <option value="Spirit" selected="@(Model.SchoolFilter == "Spirit")">灵魂</option>
                    <option value="Nature" selected="@(Model.SchoolFilter == "Nature")">自然</option>
                    <option value="Passive" selected="@(Model.SchoolFilter == "Passive")">被动</option>
                </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button type="submit" class="btn btn-primary me-2">
                    <i class="bi bi-search"></i> 搜索
                </button>
                <a href="/Skills" class="btn btn-secondary">
                    <i class="bi bi-arrow-counterclockwise"></i> 重置
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Skills List -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-list"></i> 技能列表</span>
        <span class="badge bg-secondary">共 @Model.TotalCount 个技能</span>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-striped mb-0">
                <thead class="table-dark">
                    <tr>
                        <th style="width: 60px;">ID</th>
                        <th style="width: 50px;">图标</th>
                        <th>名称</th>
                        <th>技能类型</th>
                        <th>职业</th>
                        <th>学派</th>
                        <th>基础威力</th>
                        <th>等级威力</th>
                        <th>消耗</th>
                        <th>学习等级</th>
                        <th>冷却</th>
                        <th style="width: 120px;">操作</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Magics.Count == 0)
                    {
                        <tr>
                            <td colspan="12" class="text-center text-muted py-4">
                                <i class="bi bi-inbox display-4 d-block mb-2"></i>
                                没有找到技能数据
                            </td>
                        </tr>
                    }
                    @foreach (var magic in Model.Magics)
                    {
                        <tr>
                            <td><code>@magic.Index</code></td>
                            <td>
                                <span class="badge bg-secondary">@magic.Icon</span>
                            </td>
                            <td>
                                <strong>@magic.Name</strong>
                                <br><small class="text-muted">@magic.Magic</small>
                            </td>
                            <td><span class="badge bg-info">@magic.Mode</span></td>
                            <td>
                                @switch (magic.Class)
                                {
                                    case "Warrior":
                                        <span class="badge bg-danger">战士</span>
                                        break;
                                    case "Wizard":
                                        <span class="badge bg-primary">法师</span>
                                        break;
                                    case "Taoist":
                                        <span class="badge bg-success">道士</span>
                                        break;
                                    case "Assassin":
                                        <span class="badge bg-dark">刺客</span>
                                        break;
                                    default:
                                        <span class="badge bg-secondary">@magic.Class</span>
                                        break;
                                }
                            </td>
                            <td><span class="badge bg-secondary">@magic.School</span></td>
                            <td>
                                <small>@magic.MinBasePower - @magic.MaxBasePower</small>
                            </td>
                            <td>
                                <small>@magic.MinLevelPower - @magic.MaxLevelPower</small>
                            </td>
                            <td>
                                <small>@magic.BaseCost + @magic.LevelCost/级</small>
                            </td>
                            <td>
                                <small>@magic.NeedLevel1/@magic.NeedLevel2/@magic.NeedLevel3</small>
                            </td>
                            <td>
                                <small>@magic.Delay ms</small>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button type="button" class="btn btn-outline-success"
                                            onclick="fillSkillMagic(@magic.Index)"
                                            title="填入技能ID">
                                        <i class="bi bi-gift"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-primary"
                                            data-bs-toggle="modal"
                                            data-bs-target="#editModal"
                                            data-index="@magic.Index"
                                            data-name="@magic.Name"
                                            data-icon="@magic.Icon"
                                            data-minbasepower="@magic.MinBasePower"
                                            data-maxbasepower="@magic.MaxBasePower"
                                            data-minlevelpower="@magic.MinLevelPower"
                                            data-maxlevelpower="@magic.MaxLevelPower"
                                            data-basecost="@magic.BaseCost"
                                            data-levelcost="@magic.LevelCost"
                                            data-needlevel1="@magic.NeedLevel1"
                                            data-needlevel2="@magic.NeedLevel2"
                                            data-needlevel3="@magic.NeedLevel3"
                                            data-experience1="@magic.Experience1"
                                            data-experience2="@magic.Experience2"
                                            data-experience3="@magic.Experience3"
                                            data-delay="@magic.Delay"
                                            data-description="@magic.Description">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
    @if (Model.TotalPages > 1)
    {
        <div class="card-footer">
            <nav>
                <ul class="pagination pagination-sm mb-0 justify-content-center">
                    @if (Model.CurrentPage > 1)
                    {
                        <li class="page-item">
                            <a class="page-link" href="/Skills?CurrentPage=@(Model.CurrentPage - 1)&Keyword=@Model.Keyword&ClassFilter=@Model.ClassFilter&SchoolFilter=@Model.SchoolFilter">
                                <i class="bi bi-chevron-left"></i>
                            </a>
                        </li>
                    }
                    @for (int i = Math.Max(1, Model.CurrentPage - 2); i <= Math.Min(Model.TotalPages, Model.CurrentPage + 2); i++)
                    {
                        <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                            <a class="page-link" href="/Skills?CurrentPage=@i&Keyword=@Model.Keyword&ClassFilter=@Model.ClassFilter&SchoolFilter=@Model.SchoolFilter">@i</a>
                        </li>
                    }
                    @if (Model.CurrentPage < Model.TotalPages)
                    {
                        <li class="page-item">
                            <a class="page-link" href="/Skills?CurrentPage=@(Model.CurrentPage + 1)&Keyword=@Model.Keyword&ClassFilter=@Model.ClassFilter&SchoolFilter=@Model.SchoolFilter">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                    }
                </ul>
            </nav>
        </div>
    }
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" asp-page-handler="UpdateMagic">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-pencil-square"></i> 编辑技能属性</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> 需要 <strong>SuperAdmin</strong> 权限才能修改技能属性
                    </div>
                    <input type="hidden" name="index" id="edit-index">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">技能名称</label>
                            <input type="text" class="form-control" name="name" id="edit-name" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">图标 ID</label>
                            <input type="number" class="form-control" name="icon" id="edit-icon" min="0">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">最小基础威力</label>
                            <input type="number" class="form-control" name="minBasePower" id="edit-minbasepower" min="0" max="9999999">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">最大基础威力</label>
                            <input type="number" class="form-control" name="maxBasePower" id="edit-maxbasepower" min="0" max="9999999">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">最小等级威力</label>
                            <input type="number" class="form-control" name="minLevelPower" id="edit-minlevelpower" min="0" max="9999999">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">最大等级威力</label>
                            <input type="number" class="form-control" name="maxLevelPower" id="edit-maxlevelpower" min="0" max="9999999">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">基础消耗</label>
                            <input type="number" class="form-control" name="baseCost" id="edit-basecost" min="0" max="9999999">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">等级消耗</label>
                            <input type="number" class="form-control" name="levelCost" id="edit-levelcost" min="0" max="9999999">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">冷却(ms)</label>
                            <input type="number" class="form-control" name="delay" id="edit-delay" min="0" max="9999999">
                        </div>
                        <div class="col-md-3"></div>
                        <div class="col-md-4">
                            <label class="form-label">学习等级 1</label>
                            <input type="number" class="form-control" name="needLevel1" id="edit-needlevel1" min="0" max="255">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">学习等级 2</label>
                            <input type="number" class="form-control" name="needLevel2" id="edit-needlevel2" min="0" max="255">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">学习等级 3</label>
                            <input type="number" class="form-control" name="needLevel3" id="edit-needlevel3" min="0" max="255">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">升级经验 1</label>
                            <input type="number" class="form-control" name="experience1" id="edit-experience1" min="0" max="9999999">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">升级经验 2</label>
                            <input type="number" class="form-control" name="experience2" id="edit-experience2" min="0" max="9999999">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">升级经验 3</label>
                            <input type="number" class="form-control" name="experience3" id="edit-experience3" min="0" max="9999999">
                        </div>
                        <div class="col-12">
                            <label class="form-label">技能描述</label>
                            <textarea class="form-control" name="description" id="edit-description" rows="2"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg"></i> 保存修改
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // AJAX表单绑定
        document.addEventListener('DOMContentLoaded', function() {
            // 给予技能表单
            const giveSkillForm = document.querySelector('form[asp-page-handler="GiveSkill"]');
            if (giveSkillForm) {
                AjaxForm.bindOne(giveSkillForm, {
                    successMessage: '技能已成功给予玩家',
                    resetForm: true
                });
            }

            // 全职业技能表单
            const giveAllForm = document.querySelector('form[asp-page-handler="GiveAllSkills"]');
            if (giveAllForm) {
                giveAllForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    if (confirm('确定要给该玩家添加所有职业技能吗?')) {
                        AjaxForm.submit(giveAllForm, {
                            successMessage: '所有职业技能已成功给予玩家',
                            resetForm: true
                        });
                    }
                });
            }

            // 移除技能表单
            const removeSkillForm = document.querySelector('form[asp-page-handler="RemoveSkill"]');
            if (removeSkillForm) {
                removeSkillForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    if (confirm('确定要移除该玩家的技能吗?')) {
                        AjaxForm.submit(removeSkillForm, {
                            successMessage: '技能已成功移除',
                            resetForm: true
                        });
                    }
                });
            }

            // 编辑技能模态框表单
            const editMagicForm = document.querySelector('form[asp-page-handler="UpdateMagic"]');
            if (editMagicForm) {
                AjaxForm.bindOne(editMagicForm, {
                    successMessage: '技能属性已保存',
                    closeModal: true,
                    modalId: 'editModal'
                });
            }
        });

        // 填充技能ID到给予/移除表单
        function fillSkillMagic(magicIndex) {
            const giveInput = document.getElementById('giveSkillMagicIndex');
            if (giveInput) giveInput.value = magicIndex;

            const removeInput = document.getElementById('removeSkillMagicIndex');
            if (removeInput) removeInput.value = magicIndex;

            const playerInput = document.getElementById('giveSkillPlayerName');
            if (playerInput) playerInput.focus();
        }

        // Edit modal data binding
        var editModal = document.getElementById('editModal');
        editModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            document.getElementById('edit-index').value = button.getAttribute('data-index');
            document.getElementById('edit-name').value = button.getAttribute('data-name');
            document.getElementById('edit-icon').value = button.getAttribute('data-icon');
            document.getElementById('edit-minbasepower').value = button.getAttribute('data-minbasepower');
            document.getElementById('edit-maxbasepower').value = button.getAttribute('data-maxbasepower');
            document.getElementById('edit-minlevelpower').value = button.getAttribute('data-minlevelpower');
            document.getElementById('edit-maxlevelpower').value = button.getAttribute('data-maxlevelpower');
            document.getElementById('edit-basecost').value = button.getAttribute('data-basecost');
            document.getElementById('edit-levelcost').value = button.getAttribute('data-levelcost');
            document.getElementById('edit-needlevel1').value = button.getAttribute('data-needlevel1');
            document.getElementById('edit-needlevel2').value = button.getAttribute('data-needlevel2');
            document.getElementById('edit-needlevel3').value = button.getAttribute('data-needlevel3');
            document.getElementById('edit-experience1').value = button.getAttribute('data-experience1');
            document.getElementById('edit-experience2').value = button.getAttribute('data-experience2');
            document.getElementById('edit-experience3').value = button.getAttribute('data-experience3');
            document.getElementById('edit-delay').value = button.getAttribute('data-delay');
            document.getElementById('edit-description').value = button.getAttribute('data-description') || '';
        });
    </script>
}
