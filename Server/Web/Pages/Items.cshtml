@page
@model ItemsModel
@{
    ViewData["Title"] = "物品管理";
    ViewData["ActivePage"] = "Items";
}

<div class="row mb-4">
    <div class="col-12 d-flex justify-content-between align-items-center">
        <div>
            <h4 class="mb-0">物品管理</h4>
            <small class="text-muted">查看物品列表、新建物品、给予玩家物品</small>
        </div>
        <button type="button" class="btn btn-primary" onclick="createItem()">
            <i class="bi bi-plus-lg"></i> 新建物品
        </button>
    </div>
</div>

<!-- Search and Filter -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">搜索物品</label>
                <input type="text" class="form-control" name="Keyword" value="@Model.Keyword" placeholder="物品名称或ID">
            </div>
            <div class="col-md-2">
                <label class="form-label">物品类型</label>
                <select class="form-select" name="ItemType">
                    <option value="">全部类型</option>
                    <option value="Nothing" selected="@(Model.ItemType == "Nothing")">Nothing</option>
                    <option value="Weapon" selected="@(Model.ItemType == "Weapon")">武器</option>
                    <option value="Armour" selected="@(Model.ItemType == "Armour")">防具</option>
                    <option value="Helmet" selected="@(Model.ItemType == "Helmet")">头盔</option>
                    <option value="Necklace" selected="@(Model.ItemType == "Necklace")">项链</option>
                    <option value="Bracelet" selected="@(Model.ItemType == "Bracelet")">手镯</option>
                    <option value="Ring" selected="@(Model.ItemType == "Ring")">戒指</option>
                    <option value="Shoes" selected="@(Model.ItemType == "Shoes")">鞋子</option>
                    <option value="Book" selected="@(Model.ItemType == "Book")">书籍</option>
                    <option value="Potion" selected="@(Model.ItemType == "Potion")">药水</option>
                    <option value="Consumable" selected="@(Model.ItemType == "Consumable")">消耗品</option>
                    <option value="Ore" selected="@(Model.ItemType == "Ore")">矿石</option>
                    <option value="Meat" selected="@(Model.ItemType == "Meat")">肉类</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">排序方式</label>
                <select class="form-select" name="SortBy">
                    <option value="">默认排序</option>
                    <option value="price" selected="@(Model.SortBy == "price")">按价格</option>
                    <option value="name" selected="@(Model.SortBy == "name")">按名称</option>
                    <option value="level" selected="@(Model.SortBy == "level")">按等级需求</option>
                    <option value="index" selected="@(Model.SortBy == "index")">按ID</option>
                    <option value="rarity" selected="@(Model.SortBy == "rarity")">按品质</option>
                    <option value="stacksize" selected="@(Model.SortBy == "stacksize")">按堆叠数</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">排序顺序</label>
                <select class="form-select" name="SortOrder">
                    <option value="asc" selected="@(Model.SortOrder != "desc")">升序 ↑</option>
                    <option value="desc" selected="@(Model.SortOrder == "desc")">降序 ↓</option>
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-search"></i> 搜索
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Give Item Form -->
<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-gift"></i> 给予物品
    </div>
    <div class="card-body">
        <form method="post" asp-page-handler="GiveItem" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">玩家名称</label>
                <input type="text" class="form-control" name="playerName" id="givePlayerName" required placeholder="在线玩家名称">
            </div>
            <div class="col-md-3">
                <label class="form-label">物品ID</label>
                <input type="number" class="form-control" name="itemIndex" id="giveItemIndex" required placeholder="物品索引">
            </div>
            <div class="col-md-2">
                <label class="form-label">数量</label>
                <input type="number" class="form-control" name="count" value="1" min="1" max="9999999">
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-success w-100">
                    <i class="bi bi-plus-circle"></i> 给予
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Items Table -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-box-seam"></i> 物品列表</span>
        <span class="badge bg-primary" id="itemsTotalCount">共 @Model.TotalCount 件</span>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-striped mb-0">
                <thead class="table-dark">
                    <tr>
                        <th class="sortable-header" onclick="sortBy('index')" style="cursor:pointer" title="点击排序">
                            ID @Html.Raw(GetSortIcon("index"))
                        </th>
                        <th class="sortable-header" onclick="sortBy('name')" style="cursor:pointer" title="点击排序">
                            名称 @Html.Raw(GetSortIcon("name"))
                        </th>
                        <th>类型</th>
                        <th class="sortable-header" onclick="sortBy('level')" style="cursor:pointer" title="点击排序">
                            等级需求 @Html.Raw(GetSortIcon("level"))
                        </th>
                        <th class="sortable-header" onclick="sortBy('price')" style="cursor:pointer" title="点击排序">
                            价格 @Html.Raw(GetSortIcon("price"))
                        </th>
                        <th class="sortable-header" onclick="sortBy('stacksize')" style="cursor:pointer" title="点击排序">
                            堆叠 @Html.Raw(GetSortIcon("stacksize"))
                        </th>
                        <th class="sortable-header" onclick="sortBy('rarity')" style="cursor:pointer" title="点击排序">
                            品质 @Html.Raw(GetSortIcon("rarity"))
                        </th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="itemsTableBody">
                    @if (Model.Items.Any())
                    {
                        @foreach (var item in Model.Items)
                        {
                            <tr data-item-index="@item.Index">
                                <td><code>@item.Index</code></td>
                                <td>
                                    <strong class="@GetRarityClass(item.Rarity)">@item.ItemName</strong>
                                </td>
                                <td><span class="badge bg-secondary">@item.ItemType</span></td>
                                <td>@item.RequiredAmount</td>
                                <td>@item.Price.ToString("N0")</td>
                                <td>@item.StackSize</td>
                                <td><span class="badge @GetRarityBadgeClass(item.Rarity)">@item.Rarity</span></td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button type="button" class="btn btn-outline-primary"
                                                onclick="editItem(@item.Index)"
                                                title="编辑">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-success"
                                                onclick="fillGiveItem(@item.Index)"
                                                title="给予">
                                            <i class="bi bi-gift"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="8" class="text-center py-4 text-muted">
                                <i class="bi bi-inbox display-6"></i>
                                <p class="mb-0 mt-2">没有找到物品</p>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
    @if (Model.TotalPages > 1)
    {
        <div class="card-footer">
            <nav>
                <ul class="pagination pagination-sm mb-0 justify-content-center">
                    @* 首页 *@
                    <li class="page-item @(Model.CurrentPage == 1 ? "disabled" : "")">
                        <a class="page-link" href="@GetPageUrl(1)" title="首页">
                            <i class="bi bi-chevron-double-left"></i>
                        </a>
                    </li>
                    @* 上一页 *@
                    <li class="page-item @(Model.CurrentPage == 1 ? "disabled" : "")">
                        <a class="page-link" href="@GetPageUrl(Model.CurrentPage - 1)" title="上一页">
                            <i class="bi bi-chevron-left"></i>
                        </a>
                    </li>
                    @* 第一页（如果不在显示范围内） *@
                    @if (Model.CurrentPage > 3)
                    {
                        <li class="page-item">
                            <a class="page-link" href="@GetPageUrl(1)">1</a>
                        </li>
                        @if (Model.CurrentPage > 4)
                        {
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                        }
                    }
                    @* 当前页前后各2页 *@
                    @for (int i = Math.Max(1, Model.CurrentPage - 2); i <= Math.Min(Model.TotalPages, Model.CurrentPage + 2); i++)
                    {
                        <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                            <a class="page-link" href="@GetPageUrl(i)">@i</a>
                        </li>
                    }
                    @* 最后一页（如果不在显示范围内） *@
                    @if (Model.CurrentPage < Model.TotalPages - 2)
                    {
                        @if (Model.CurrentPage < Model.TotalPages - 3)
                        {
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                        }
                        <li class="page-item">
                            <a class="page-link" href="@GetPageUrl(Model.TotalPages)">@Model.TotalPages</a>
                        </li>
                    }
                    @* 下一页 *@
                    <li class="page-item @(Model.CurrentPage == Model.TotalPages ? "disabled" : "")">
                        <a class="page-link" href="@GetPageUrl(Model.CurrentPage + 1)" title="下一页">
                            <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                    @* 末页 *@
                    <li class="page-item @(Model.CurrentPage == Model.TotalPages ? "disabled" : "")">
                        <a class="page-link" href="@GetPageUrl(Model.TotalPages)" title="末页">
                            <i class="bi bi-chevron-double-right"></i>
                        </a>
                    </li>
                </ul>
                <div class="text-center mt-2">
                    <small class="text-muted">第 @Model.CurrentPage / @Model.TotalPages 页</small>
                </div>
            </nav>
        </div>
    }
</div>

<!-- Item Modal (Create/Edit) -->
<div class="modal fade" id="itemModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="itemModalTitle"><i class="bi bi-box-seam"></i> 新建物品</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" id="itemForm">
                <div class="modal-body">
                    <input type="hidden" name="itemIndex" id="editItemIndex">

                    <!-- Basic Info -->
                    <h6 class="border-bottom pb-2 mb-3"><i class="bi bi-info-circle"></i> 基本信息</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <label class="form-label">物品名称 *</label>
                            <input type="text" class="form-control" name="itemName" id="editItemName" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">物品类型</label>
                            <select class="form-select" name="itemType" id="editItemType">
                                <option value="0">Nothing</option>
                                <option value="1">Weapon (武器)</option>
                                <option value="2">Armour (防具)</option>
                                <option value="3">Helmet (头盔)</option>
                                <option value="4">Necklace (项链)</option>
                                <option value="5">Bracelet (手镯)</option>
                                <option value="6">Ring (戒指)</option>
                                <option value="7">Shoes (鞋子)</option>
                                <option value="8">Book (书籍)</option>
                                <option value="9">Potion (药水)</option>
                                <option value="10">Ore (矿石)</option>
                                <option value="11">Meat (肉类)</option>
                                <option value="12">Consumable (消耗品)</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">品质</label>
                            <select class="form-select" name="rarity" id="editRarity">
                                <option value="0">Common (普通)</option>
                                <option value="1">Superior (优秀)</option>
                                <option value="2">Elite (精英)</option>
                            </select>
                        </div>
                    </div>

                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <label class="form-label">需求类型</label>
                            <select class="form-select" name="requiredType" id="editRequiredType">
                                <option value="0">None</option>
                                <option value="1">Level (等级)</option>
                                <option value="2">AC (防御)</option>
                                <option value="3">MR (魔防)</option>
                                <option value="4">DC (攻击)</option>
                                <option value="5">MC (魔法)</option>
                                <option value="6">SC (道术)</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">需求数值</label>
                            <input type="number" class="form-control" name="requiredAmount" id="editRequiredAmount" min="0" max="9999999" value="0">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">职业限制</label>
                            <select class="form-select" name="requiredClass" id="editRequiredClass">
                                <option value="0">None (无限制)</option>
                                <option value="1">Warrior (战士)</option>
                                <option value="2">Wizard (法师)</option>
                                <option value="4">Taoist (道士)</option>
                                <option value="7">All (全职业)</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">性别限制</label>
                            <select class="form-select" name="requiredGender" id="editRequiredGender">
                                <option value="0">None (无限制)</option>
                                <option value="1">Male (男)</option>
                                <option value="2">Female (女)</option>
                            </select>
                        </div>
                    </div>

                    <h6 class="border-bottom pb-2 mb-3"><i class="bi bi-bar-chart"></i> 属性</h6>
                    <div class="row g-3 mb-3">
                        <div class="col-md-3">
                            <label class="form-label">形状 (Shape)</label>
                            <input type="number" class="form-control" name="shape" id="editShape" min="0" max="9999999" value="0">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">图像 (Image)</label>
                            <input type="number" class="form-control" name="image" id="editImage" min="0" max="9999999" value="0">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">耐久度</label>
                            <input type="number" class="form-control" name="durability" id="editDurability" min="0" max="9999999" value="0">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">重量</label>
                            <input type="number" class="form-control" name="weight" id="editWeight" min="0" max="9999999" value="0">
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            <label class="form-label">价格</label>
                            <input type="number" class="form-control" name="price" id="editPrice" min="0" max="9999999" value="0">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">堆叠数量</label>
                            <input type="number" class="form-control" name="stackSize" id="editStackSize" min="1" max="9999999" value="1">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">特殊效果</label>
                            <input type="number" class="form-control" name="effect" id="editEffect" min="0" max="9999999" value="0" title="ItemEffect枚举值">
                        </div>
                    </div>

                    <!-- 装备属性编辑区域 -->
                    <h6 class="border-bottom pb-2 mb-3"><i class="bi bi-shield-fill"></i> 装备属性</h6>
                    <input type="hidden" name="stats" id="editStats">

                    <!-- 常用属性快捷输入 -->
                    <div class="row g-2 mb-3">
                        <!-- 基础防御 -->
                        <div class="col-md-6">
                            <div class="card border-secondary">
                                <div class="card-header py-1 bg-secondary text-white small">
                                    <i class="bi bi-shield"></i> 基础防御
                                </div>
                                <div class="card-body py-2">
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <label class="form-label small mb-1">物防 (AC)</label>
                                            <div class="input-group input-group-sm">
                                                <input type="number" class="form-control stat-input" data-stat="3" id="statMinAC" placeholder="最小">
                                                <span class="input-group-text">-</span>
                                                <input type="number" class="form-control stat-input" data-stat="4" id="statMaxAC" placeholder="最大">
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label small mb-1">魔防 (MR)</label>
                                            <div class="input-group input-group-sm">
                                                <input type="number" class="form-control stat-input" data-stat="5" id="statMinMR" placeholder="最小">
                                                <span class="input-group-text">-</span>
                                                <input type="number" class="form-control stat-input" data-stat="6" id="statMaxMR" placeholder="最大">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- 攻击力 -->
                        <div class="col-md-6">
                            <div class="card border-danger">
                                <div class="card-header py-1 bg-danger text-white small">
                                    <i class="bi bi-lightning"></i> 攻击力
                                </div>
                                <div class="card-body py-2">
                                    <div class="row g-2">
                                        <div class="col-4">
                                            <label class="form-label small mb-1">攻击 (DC)</label>
                                            <div class="input-group input-group-sm">
                                                <input type="number" class="form-control stat-input" data-stat="7" id="statMinDC" placeholder="最小">
                                                <span class="input-group-text">-</span>
                                                <input type="number" class="form-control stat-input" data-stat="8" id="statMaxDC" placeholder="最大">
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <label class="form-label small mb-1">魔法 (MC)</label>
                                            <div class="input-group input-group-sm">
                                                <input type="number" class="form-control stat-input" data-stat="9" id="statMinMC" placeholder="最小">
                                                <span class="input-group-text">-</span>
                                                <input type="number" class="form-control stat-input" data-stat="10" id="statMaxMC" placeholder="最大">
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <label class="form-label small mb-1">道术 (SC)</label>
                                            <div class="input-group input-group-sm">
                                                <input type="number" class="form-control stat-input" data-stat="11" id="statMinSC" placeholder="最小">
                                                <span class="input-group-text">-</span>
                                                <input type="number" class="form-control stat-input" data-stat="12" id="statMaxSC" placeholder="最大">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 基础属性 -->
                    <div class="row g-2 mb-3">
                        <div class="col-12">
                            <div class="card border-info">
                                <div class="card-header py-1 bg-info text-white small">
                                    <i class="bi bi-heart"></i> 基础属性
                                </div>
                                <div class="card-body py-2">
                                    <div class="row g-2">
                                        <div class="col-md-2">
                                            <label class="form-label small mb-1">生命</label>
                                            <input type="number" class="form-control form-control-sm stat-input" data-stat="0" id="statHealth" placeholder="0">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label small mb-1">魔法</label>
                                            <input type="number" class="form-control form-control-sm stat-input" data-stat="1" id="statMana" placeholder="0">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label small mb-1">准确</label>
                                            <input type="number" class="form-control form-control-sm stat-input" data-stat="13" id="statAccuracy" placeholder="0">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label small mb-1">敏捷</label>
                                            <input type="number" class="form-control form-control-sm stat-input" data-stat="14" id="statAgility" placeholder="0">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label small mb-1">攻速</label>
                                            <input type="number" class="form-control form-control-sm stat-input" data-stat="20" id="statAttackSpeed" placeholder="0">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label small mb-1">幸运</label>
                                            <input type="number" class="form-control form-control-sm stat-input" data-stat="21" id="statLuck" placeholder="0">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 其他属性（可折叠） -->
                    <div class="accordion mb-3" id="advancedStatsAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#advancedStatsCollapse">
                                    <i class="bi bi-gear me-2"></i> 其他属性
                                    <span class="badge bg-secondary ms-2" id="advancedStatsCount">0</span>
                                </button>
                            </h2>
                            <div id="advancedStatsCollapse" class="accordion-collapse collapse" data-bs-parent="#advancedStatsAccordion">
                                <div class="accordion-body p-2">
                                    <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                                        <table class="table table-sm table-bordered mb-2">
                                            <thead class="table-light">
                                                <tr>
                                                    <th style="width: 50%;">属性类型</th>
                                                    <th style="width: 30%;">数值</th>
                                                    <th style="width: 20%;">操作</th>
                                                </tr>
                                            </thead>
                                            <tbody id="advancedStatsList">
                                                <!-- 动态生成 -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <select class="form-select form-select-sm" id="newStatType" style="flex: 1;">
                                            <option value="">-- 选择属性 --</option>
                                        </select>
                                        <input type="number" class="form-control form-control-sm" id="newStatValue" placeholder="数值" style="width: 100px;">
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addAdvancedStat()">
                                            <i class="bi bi-plus"></i> 添加
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <span class="text-muted me-auto"><i class="bi bi-exclamation-triangle"></i> 需要 SuperAdmin 权限</span>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg"></i> 保存
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@functions {
    string GetRarityClass(string rarity)
    {
        return rarity switch
        {
            "Common" => "text-secondary",
            "Superior" => "text-success",
            "Elite" => "text-primary",
            _ => ""
        };
    }

    string GetRarityBadgeClass(string rarity)
    {
        return rarity switch
        {
            "Common" => "bg-secondary",
            "Superior" => "bg-success",
            "Elite" => "bg-primary",
            _ => "bg-secondary"
        };
    }

    string GetSortIcon(string field)
    {
        if (Model.SortBy?.ToLower() != field.ToLower())
            return "<i class=\"bi bi-arrow-down-up text-muted opacity-50\"></i>";

        return Model.SortOrder == "desc"
            ? "<i class=\"bi bi-sort-down text-warning\"></i>"
            : "<i class=\"bi bi-sort-up text-warning\"></i>";
    }

    string GetPageUrl(int page)
    {
        return $"?Keyword={Model.Keyword}&ItemType={Model.ItemType}&SortBy={Model.SortBy}&SortOrder={Model.SortOrder}&CurrentPage={page}";
    }
}

@section Scripts {
<script>
// 当前排序状态
const currentSortBy = '@Model.SortBy';
const currentSortOrder = '@Model.SortOrder';

// 点击表头排序
function sortBy(field) {
    const params = new URLSearchParams(window.location.search);

    // 如果点击同一列，切换排序方向
    if (params.get('SortBy') === field) {
        params.set('SortOrder', params.get('SortOrder') === 'desc' ? 'asc' : 'desc');
    } else {
        params.set('SortBy', field);
        params.set('SortOrder', 'asc');
    }

    // 重置到第一页
    params.set('CurrentPage', '1');

    window.location.search = params.toString();
}

const rarityClassMap = {
    Common: 'text-secondary',
    Superior: 'text-success',
    Elite: 'text-primary'
};

const rarityBadgeClassMap = {
    Common: 'bg-secondary',
    Superior: 'bg-success',
    Elite: 'bg-primary'
};

function formatNumber(value) {
    const num = Number(value || 0);
    return Number.isFinite(num) ? num.toLocaleString() : '0';
}

function escapeHtml(value) {
    const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
    return String(value ?? '').replace(/[&<>"']/g, (m) => map[m]);
}

function buildItemRow(item) {
    const rarityClass = rarityClassMap[item.rarity] || '';
    const rarityBadge = rarityBadgeClassMap[item.rarity] || 'bg-secondary';
    const name = escapeHtml(item.itemName);
    const itemType = escapeHtml(item.itemType);
    const rarity = escapeHtml(item.rarity);
    return `<tr data-item-index="${item.index}">
                <td><code>${item.index}</code></td>
                <td><strong class="${rarityClass}">${name}</strong></td>
                <td><span class="badge bg-secondary">${itemType}</span></td>
                <td>${item.requiredAmount}</td>
                <td>${formatNumber(item.price)}</td>
                <td>${item.stackSize}</td>
                <td><span class="badge ${rarityBadge}">${rarity}</span></td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-outline-primary" onclick="editItem(${item.index})" title="编辑">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button type="button" class="btn btn-outline-success" onclick="fillGiveItem(${item.index})" title="给予">
                            <i class="bi bi-gift"></i>
                        </button>
                    </div>
                </td>
            </tr>`;
}

function upsertItemRow(item) {
    if (!item) return;
    const tbody = document.getElementById('itemsTableBody');
    if (!tbody) return;

    const existing = tbody.querySelector(`[data-item-index="${item.index}"]`);
    const rowHtml = buildItemRow(item);
    if (existing) {
        existing.outerHTML = rowHtml;
    } else {
        tbody.insertAdjacentHTML('afterbegin', rowHtml);
        const badge = document.getElementById('itemsTotalCount');
        if (badge) {
            const match = badge.textContent.match(/共\\s*(\\d+)\\s*件/);
            if (match) {
                const count = Math.max(0, parseInt(match[1], 10) + 1);
                badge.textContent = `共 ${count} 件`;
            }
        }
    }
}

// 给予物品表单 - AJAX提交
document.addEventListener('DOMContentLoaded', function() {
    const giveItemForm = document.querySelector('form[asp-page-handler="GiveItem"]');
    if (giveItemForm) {
        AjaxForm.bindOne(giveItemForm, {
            successMessage: '物品已成功给予玩家',
            resetForm: true
        });
    }

    // 物品模态框表单 - AJAX提交
    const itemForm = document.getElementById('itemForm');
    if (itemForm) {
        AjaxForm.bindOne(itemForm, {
            successMessage: '物品信息已保存',
            closeModal: true,
            modalId: 'itemModal',
            onSuccess: function(result) {
                if (result && result.data) {
                    upsertItemRow(result.data);
                }
            }
        });
    }
});

function fillGiveItem(itemIndex) {
    document.getElementById('giveItemIndex').value = itemIndex;
    document.getElementById('givePlayerName').focus();
}

function createItem() {
    // Reset form
    document.getElementById('itemForm').reset();
    document.getElementById('itemForm').action = '/Items?handler=CreateItem';
    document.getElementById('editItemIndex').value = '';
    document.getElementById('itemModalTitle').innerHTML = '<i class="bi bi-plus-lg"></i> 新建物品';

    // 重置属性编辑区域
    clearAllStats();

    new bootstrap.Modal(document.getElementById('itemModal')).show();
}

function editItem(itemIndex) {
    // Fetch item details
    fetch(`/Items?handler=ItemDetail&itemIndex=${itemIndex}`)
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                const data = result.data;
                // Fill form
                document.getElementById('itemForm').action = '/Items?handler=UpdateItem';
                document.getElementById('editItemIndex').value = data.index;
                document.getElementById('editItemName').value = data.itemName;
                document.getElementById('editItemType').value = data.itemType;
                document.getElementById('editRequiredClass').value = data.requiredClass;
                document.getElementById('editRequiredGender').value = data.requiredGender;
                document.getElementById('editRequiredType').value = data.requiredType;
                document.getElementById('editRequiredAmount').value = data.requiredAmount;
                document.getElementById('editShape').value = data.shape;
                document.getElementById('editEffect').value = data.effect;
                document.getElementById('editImage').value = data.image;
                document.getElementById('editDurability').value = data.durability;
                document.getElementById('editPrice').value = data.price;
                document.getElementById('editWeight').value = data.weight;
                document.getElementById('editStackSize').value = data.stackSize;
                document.getElementById('editRarity').value = data.rarity;

                // 加载属性
                loadItemStats(data.stats || []);

                document.getElementById('itemModalTitle').innerHTML = '<i class="bi bi-pencil"></i> 编辑物品 [' + data.index + ']';
                new bootstrap.Modal(document.getElementById('itemModal')).show();
            } else {
                ToastManager.error('加载物品信息失败: ' + result.message);
            }
        })
        .catch(error => {
            ToastManager.error('请求失败: ' + error.message);
        });
}

// ==================== 属性编辑功能 ====================

// 常用属性映射表 (statType -> inputId)
const quickStatInputs = {
    0: 'statHealth',      // Health
    1: 'statMana',        // Mana
    3: 'statMinAC',       // MinAC
    4: 'statMaxAC',       // MaxAC
    5: 'statMinMR',       // MinMR
    6: 'statMaxMR',       // MaxMR
    7: 'statMinDC',       // MinDC
    8: 'statMaxDC',       // MaxDC
    9: 'statMinMC',       // MinMC
    10: 'statMaxMC',      // MaxMC
    11: 'statMinSC',      // MinSC
    12: 'statMaxSC',      // MaxSC
    13: 'statAccuracy',   // Accuracy
    14: 'statAgility',    // Agility
    20: 'statAttackSpeed',// AttackSpeed
    21: 'statLuck'        // Luck
};

// 高级属性列表（用于其他属性下拉框）
let allStatTypes = [];
let advancedStats = []; // 当前的高级属性列表

// 初始化时加载属性类型列表
document.addEventListener('DOMContentLoaded', function() {
    loadStatTypes();
});

// 加载属性类型列表
function loadStatTypes() {
    fetch('/Items?handler=StatTypes')
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                allStatTypes = [];
                const select = document.getElementById('newStatType');
                select.innerHTML = '<option value="">-- 选择属性 --</option>';

                // 按分组填充下拉框
                result.data.forEach(group => {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = group.group;
                    group.stats.forEach(stat => {
                        allStatTypes.push(stat);
                        // 过滤掉常用属性（已在快捷输入中）
                        if (!quickStatInputs.hasOwnProperty(stat.value)) {
                            const option = document.createElement('option');
                            option.value = stat.value;
                            option.textContent = stat.name;
                            optgroup.appendChild(option);
                        }
                    });
                    if (optgroup.children.length > 0) {
                        select.appendChild(optgroup);
                    }
                });
            }
        })
        .catch(error => console.error('加载属性类型失败:', error));
}

// 清空所有属性
function clearAllStats() {
    // 清空常用属性输入框
    document.querySelectorAll('.stat-input').forEach(input => {
        input.value = '';
    });

    // 清空高级属性列表
    advancedStats = [];
    renderAdvancedStats();

    // 清空隐藏字段
    document.getElementById('editStats').value = '';
}

// 加载物品属性到表单
function loadItemStats(stats) {
    clearAllStats();

    if (!stats || !Array.isArray(stats)) return;

    stats.forEach(stat => {
        const statType = stat.statType;
        const amount = stat.amount;

        // 检查是否是常用属性
        if (quickStatInputs.hasOwnProperty(statType)) {
            const inputId = quickStatInputs[statType];
            const input = document.getElementById(inputId);
            if (input) {
                input.value = amount;
            }
        } else {
            // 添加到高级属性列表
            advancedStats.push({
                statType: statType,
                statName: stat.statName || getStatName(statType),
                amount: amount
            });
        }
    });

    renderAdvancedStats();
}

// 获取属性名称
function getStatName(statType) {
    const stat = allStatTypes.find(s => s.value === statType);
    return stat ? stat.name : `Stat_${statType}`;
}

// 渲染高级属性列表
function renderAdvancedStats() {
    const tbody = document.getElementById('advancedStatsList');
    const countBadge = document.getElementById('advancedStatsCount');

    tbody.innerHTML = '';
    countBadge.textContent = advancedStats.length;

    advancedStats.forEach((stat, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><span class="badge bg-secondary">${escapeHtml(stat.statName)}</span></td>
            <td>
                <input type="number" class="form-control form-control-sm advanced-stat-amount"
                       data-index="${index}" value="${stat.amount}" onchange="updateAdvancedStat(${index}, this.value)">
            </td>
            <td>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeAdvancedStat(${index})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// 添加高级属性
function addAdvancedStat() {
    const select = document.getElementById('newStatType');
    const valueInput = document.getElementById('newStatValue');

    const statType = parseInt(select.value);
    const amount = parseInt(valueInput.value) || 0;

    if (!statType) {
        ToastManager.warning('请选择属性类型');
        return;
    }

    if (amount === 0) {
        ToastManager.warning('请输入属性数值');
        return;
    }

    // 检查是否已存在
    if (advancedStats.some(s => s.statType === statType)) {
        ToastManager.warning('该属性已存在');
        return;
    }

    // 检查是否是常用属性（不应该添加到高级列表）
    if (quickStatInputs.hasOwnProperty(statType)) {
        ToastManager.warning('该属性请使用上方快捷输入');
        return;
    }

    advancedStats.push({
        statType: statType,
        statName: getStatName(statType),
        amount: amount
    });

    renderAdvancedStats();

    // 清空输入
    select.value = '';
    valueInput.value = '';
}

// 更新高级属性值
function updateAdvancedStat(index, value) {
    if (advancedStats[index]) {
        advancedStats[index].amount = parseInt(value) || 0;
    }
}

// 删除高级属性
function removeAdvancedStat(index) {
    advancedStats.splice(index, 1);
    renderAdvancedStats();
}

// 收集所有属性并更新隐藏字段
function collectAllStats() {
    const stats = [];

    // 收集常用属性
    document.querySelectorAll('.stat-input').forEach(input => {
        const statType = parseInt(input.dataset.stat);
        const amount = parseInt(input.value) || 0;
        if (amount !== 0) {
            stats.push({ statType: statType, amount: amount });
        }
    });

    // 收集高级属性
    advancedStats.forEach(stat => {
        if (stat.amount !== 0) {
            stats.push({ statType: stat.statType, amount: stat.amount });
        }
    });

    // 更新隐藏字段
    document.getElementById('editStats').value = JSON.stringify(stats);
}

// 表单提交前收集属性
document.addEventListener('DOMContentLoaded', function() {
    const itemForm = document.getElementById('itemForm');
    if (itemForm) {
        itemForm.addEventListener('submit', function(e) {
            collectAllStats();
        });
    }
});
</script>
}
